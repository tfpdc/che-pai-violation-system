<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ license_plate }} - è¿åœè®°å½•è¯¦æƒ…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .license-plate-title {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #4facfe;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .violation-list {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .violation-item {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.3s;
        }
        
        .violation-item:hover {
            background-color: #f8f9fa;
        }
        
        .violation-item:last-child {
            border-bottom: none;
        }
        
        .violation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .violation-type {
            display: inline-block;
            padding: 6px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .timestamp {
            font-size: 12px;
            color: #999;
            text-align: right;
        }
        
        .location {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .violation-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .violation-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .violation-info {
            flex: 1;
            margin-right: 15px;
        }
        
        .violation-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            min-width: 80px;
        }
        
        .description {
            font-size: 14px;
            color: #555;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .photo-container {
            margin-top: 15px;
        }
        
        /* åœ°ç‚¹æ—¶é—´æ˜¾ç¤ºæ ·å¼ */
        .location-time-header {
            padding: 10px 0;
            margin-bottom: 10px;
        }
        
        .location-time-display {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            line-height: 1.4;
        }
        
        .time-part {
            font-weight: 700;
            color: #666;
            margin-left: 8px;
        }
        
        .photo {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .photo:hover {
            transform: scale(1.02);
        }
        
        .no-photo {
            color: #999;
            font-style: italic;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            border-radius: 25px;
            transition: background-color 0.3s;
        }
        
        .back-link:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-close:hover {
            opacity: 0.7;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .delete-btn {
            padding: 4px 8px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .delete-btn:hover {
            background: #ff3838;
        }
        
        .delete-all-btn {
            padding: 8px 16px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .delete-all-btn:hover {
            background: #ff3838;
            transform: translateY(-1px);
        }
        
        .edit-btn {
            padding: 4px 8px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 5px;
        }
        
        .edit-btn:hover {
            background: #3b8bfe;
        }
        
        .save-btn {
            padding: 8px 16px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 8px;
        }
        
        .save-btn:hover {
            background: #27ae60;
        }
        
        .cancel-btn {
            padding: 8px 16px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #4facfe;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .edit-input:focus {
            border-color: #3b8bfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px 12px;
            border: 2px solid #4facfe;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .edit-textarea:focus {
            border-color: #3b8bfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .edit-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #4facfe;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.3s;
            background-color: white;
        }
        
        .edit-select:focus {
            border-color: #3b8bfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        

        
        .image-operations {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .image-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e1e8ed;
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 6px;
            margin-right: 12px;
            border: 1px solid #e1e8ed;
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .image-info {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
        .image-name {
            font-size: 13px;
            color: #666;
            margin-left: 8px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .image-actions {
            display: flex;
            gap: 5px;
        }
        
        .rename-btn, .delete-image-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .rename-btn {
            background: #4facfe;
            color: white;
        }
        
        .rename-btn:hover {
            background: #3b8bfe;
        }
        
        .delete-image-btn {
            background: #ff6b6b;
            color: white;
        }
        
        .delete-image-btn:hover {
            background: #ff5252;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="license-plate-title">{{ license_plate }}</h1>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number">{{ total_count }}</div>
                    <div class="stat-label">æ€»è¿åœæ¬¡æ•°</div>
                </div>
                {% if first_violation %}
                <div class="stat-item">
                    <div class="stat-number" data-date="{{ first_violation }}">{{ first_violation[:10] }}</div>
                    <div class="stat-label">é¦–æ¬¡è¿è§„</div>
                </div>
                {% endif %}
                {% if last_violation %}
                <div class="stat-item">
                    <div class="stat-number" data-date="{{ last_violation }}">{{ last_violation[:10] }}</div>
                    <div class="stat-label">æœ€è¿‘è¿è§„</div>
                </div>
                {% endif %}
            </div>
            

            {% if total_count >= 5 %}
            <div style="margin-top: 15px; padding: 8px 16px; background: #ffebee; color: #c62828; border-radius: 20px; font-size: 14px; font-weight: 600;">
                âš ï¸ é«˜é¢‘è¿è§„è½¦è¾†
            </div>
            {% elif total_count >= 3 %}
            <div style="margin-top: 15px; padding: 8px 16px; background: #fff3e0; color: #ef6c00; border-radius: 20px; font-size: 14px; font-weight: 600;">
                âš¡ ä¸­é¢‘è¿è§„è½¦è¾†
            </div>
            {% else %}
            <div style="margin-top: 15px; padding: 8px 16px; background: #e8f5e8; color: #2e7d32; border-radius: 20px; font-size: 14px; font-weight: 600;">
                âœ… ä½é¢‘è¿è§„è½¦è¾†
            </div>
            {% endif %}
        </div>
        
        <div class="violation-list">
            {% if violations %}
                {% for violation in violations %}
                <div class="violation-item" id="violation-{{ violation[0] }}">
                    <!-- åœ°ç‚¹æ—¶é—´åˆ†ä¸¤è¡Œæ˜¾ç¤º -->
                    <div class="violation-content">
                        <div class="location-time-header">
                            <div class="location-time-display" id="location-time-display-{{ violation[0] }}">
                                ğŸ“ {{ violation[2] }}
                            </div>
                        </div>
                        
                        <div class="location-time-header" style="margin-top: 5px;">
                            <div class="location-time-display" id="time-display-{{ violation[0] }}">
                                â° {{ violation[7] if violation|length > 7 else violation[6] }}
                            </div>
                        </div>
                        
                        <div class="violation-type" id="type-display-{{ violation[0] }}">ğŸš« {{ violation[3] }}</div>
                        
                        {% if violation[4] %}
                        <div class="description-box" id="description-display-{{ violation[0] }}" style="margin-top: 8px;">
                            <div class="description-label">ğŸ“„ æè¿°:</div>
                            <div class="description-content">{{ violation[4] }}</div>
                        </div>
                        {% endif %}
                    
                    <!-- å›¾ç‰‡å’Œæ“ä½œæŒ‰é’®åŒºåŸŸ -->
                    <div class="violation-main">
                        <div class="violation-info">
                            {% if violation[5] %}
                            <div class="photo-container" id="photo-container-{{ loop.index }}">
                                <!-- ç…§ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                            {% else %}
                            <div class="photo-container">
                                <div class="no-photo">ğŸ“· æ— ç…§ç‰‡</div>
                            </div>
                            {% endif %}
                            
                            <div class="timestamp" style="font-size: 12px; color: #888; text-align: right; margin-top: 10px; padding-top: 5px; border-top: 1px dashed #eee;">
                                {{ violation[7] if violation|length > 7 else violation[6] }}
                            </div>
                            
                            <!-- ç¼–è¾‘åˆ é™¤æŒ‰é’®ç§»åˆ°å›¾ç‰‡ä¸‹æ–¹ -->
                            <div class="violation-actions" style="margin-top: 10px; text-align: right;">
                                <div id="action-buttons-{{ violation[0] }}">
                                    <button class="edit-btn" onclick="enterEditMode({{ violation[0] }})" title="ç¼–è¾‘æ­¤è®°å½•">
                                        âœï¸ ç¼–è¾‘
                                    </button>
                                    <button class="delete-btn" onclick="deleteViolation({{ violation[0] }})" title="åˆ é™¤æ­¤è®°å½•">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>
                                <div id="edit-buttons-{{ violation[0] }}" style="display: none;">
                                    <button class="save-btn" onclick="saveViolation({{ violation[0] }})" title="ä¿å­˜ä¿®æ”¹">
                                        ğŸ’¾ ä¿å­˜
                                    </button>
                                    <button class="cancel-btn" onclick="cancelEdit({{ violation[0] }})" title="å–æ¶ˆç¼–è¾‘">
                                        âŒ å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç¼–è¾‘è¡¨å• -->
                    <div id="edit-form-{{ violation[0] }}" style="display: none;">
                        <select class="edit-select" id="type-input-{{ violation[0] }}">
                            <option value="å ç”¨æ¶ˆé˜²é€šé“" {% if violation[3] == 'å ç”¨æ¶ˆé˜²é€šé“' %}selected{% endif %}>å ç”¨æ¶ˆé˜²é€šé“</option>
                            <option value="å ç”¨äººè¡Œé“" {% if violation[3] == 'å ç”¨äººè¡Œé“' %}selected{% endif %}>å ç”¨äººè¡Œé“</option>
                            <option value="é€†å‘åœè½¦" {% if violation[3] == 'é€†å‘åœè½¦' %}selected{% endif %}>é€†å‘åœè½¦</option>
                            <option value="å‹çº¿åœè½¦" {% if violation[3] == 'å‹çº¿åœè½¦' %}selected{% endif %}>å‹çº¿åœè½¦</option>
                            <option value="ç¦æ­¢åœè½¦åŒºåŸŸ" {% if violation[3] == 'ç¦æ­¢åœè½¦åŒºåŸŸ' %}selected{% endif %}>ç¦æ­¢åœè½¦åŒºåŸŸ</option>
                            <option value="å…¶ä»–" {% if violation[3] == 'å…¶ä»–' %}selected{% endif %}>å…¶ä»–</option>
                        </select>
                        <input type="text" class="edit-input" id="location-input-{{ violation[0] }}" 
                               placeholder="è¯·è¾“å…¥è¿è§„åœ°ç‚¹" value="{{ violation[2] }}">
                        <textarea class="edit-textarea" id="description-input-{{ violation[0] }}" 
                                  placeholder="è¯·è¾“å…¥è¿è§„æè¿°ï¼ˆå¯é€‰ï¼‰">{% if violation[4] %}{{ violation[4] }}{% endif %}</textarea>
                        <input type="datetime-local" class="violation-time-input" id="violation-time-input-{{ violation[0] }}" 
                               value="{{ violation[7] if violation|length > 7 else violation[6] }}">
                        <div style="font-size: 11px; color: #666; margin-top: 2px;">
                            ğŸ“… è¿è§„æ—¶é—´ï¼ˆå¯ä¿®æ”¹ï¼‰
                        </div>
                        
                        <!-- å›¾ç‰‡æ“ä½œåŒºåŸŸ -->
                        <div class="image-operations" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #333;">ğŸ“· å›¾ç‰‡æ“ä½œ</div>
                            
                            <!-- æ·»åŠ æ–°å›¾ç‰‡ -->
                            <div style="margin-bottom: 10px;">
                                <input type="file" id="new-image-{{ violation[0] }}" accept="image/*" style="display: none;" onchange="previewNewImage({{ violation[0] }})">
                                <button type="button" class="edit-btn" onclick="document.getElementById('new-image-{{ violation[0] }}').click()" style="width: 100%;">
                                    â• æ·»åŠ æ–°å›¾ç‰‡
                                </button>
                                <div id="new-image-preview-{{ violation[0] }}" style="margin-top: 10px;"></div>
                            </div>
                            
                            <!-- ç°æœ‰å›¾ç‰‡ç®¡ç† -->
                            <div id="existing-images-{{ violation[0] }}">
                                <!-- ç°æœ‰å›¾ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸš—</div>
                    <p>æš‚æ— è¿åœè®°å½•</p>
                </div>
            {% endif %}
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="delete-all-btn" onclick="deleteAllViolations('{{ license_plate }}')" title="åˆ é™¤æ­¤è½¦ç‰Œçš„æ‰€æœ‰è®°å½•">
                ğŸ—‘ï¸ åˆ é™¤ {{ license_plate }} çš„æ‰€æœ‰è®°å½•
            </button>
        </div>
        
        <a href="/" class="back-link">â† è¿”å›è®°å½•åˆ—è¡¨</a>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="photoModal" class="modal" onclick="closeModal()">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script>
        function formatTime(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¶é—´';
            
            // å°è¯•è§£ææ—¥æœŸå­—ç¬¦ä¸²
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                console.warn('æ— æ•ˆçš„æ—¥æœŸæ ¼å¼:', dateString);
                return 'æœªçŸ¥æ—¶é—´';
            }
            
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return `ä»Šå¤©${date.getHours().toString().padStart(2, '0')}ç‚¹${date.getMinutes().toString().padStart(2, '0')}åˆ†`;
            } else if (diffDays === 1) {
                return `æ˜¨å¤©${date.getHours().toString().padStart(2, '0')}ç‚¹${date.getMinutes().toString().padStart(2, '0')}åˆ†`;
            } else {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hour = date.getHours().toString().padStart(2, '0');
                const minute = date.getMinutes().toString().padStart(2, '0');
                return `${year}.${month}.${day}å·${hour}ç‚¹${minute}åˆ†`;
            }
        }
        
        function formatLocationTime(location, violationTime) {
            const formattedTime = formatTime(violationTime);
            return `ğŸ“ ${location}${formattedTime}`;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'ä»Šå¤©';
            } else if (diffDays === 1) {
                return 'æ˜¨å¤©';
            } else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            } else if (diffDays < 30) {
                return `${Math.floor(diffDays / 7)}å‘¨å‰`;
            } else if (diffDays < 365) {
                return `${Math.floor(diffDays / 30)}æœˆå‰`;
            } else {
                return `${Math.floor(diffDays / 365)}å¹´å‰`;
            }
        }
        
        function openModal(imageSrc) {
            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalImage');
            
            modal.style.display = 'flex';
            modalImg.src = imageSrc;
        }
        
        function closeModal() {
            document.getElementById('photoModal').style.display = 'none';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ ¼å¼åŒ–æ—¶é—´å’ŒåŠ è½½ç…§ç‰‡
        document.addEventListener('DOMContentLoaded', function() {
            // æ ¼å¼åŒ–æ—¶é—´æˆ³
            const timestampElements = document.querySelectorAll('.timestamp');
            timestampElements.forEach(element => {
                if (element.textContent && element.textContent.includes('-')) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è®°å½•æ—¶é—´å…ƒç´ ï¼ˆåŒ…å«"è®°å½•æ—¶é—´:"å‰ç¼€ï¼‰
                    if (element.textContent.startsWith('è®°å½•æ—¶é—´:')) {
                        const timeStr = element.textContent.replace('è®°å½•æ—¶é—´:', '').trim();
                        element.textContent = 'è®°å½•æ—¶é—´: ' + formatTime(timeStr);
                    } else {
                        element.textContent = formatTime(element.textContent);
                    }
                }
            });
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const dateElements = document.querySelectorAll('.stat-number[data-date]');
            dateElements.forEach(element => {
                const dateString = element.getAttribute('data-date');
                if (dateString) {
                    element.textContent = formatDate(dateString);
                }
            });
            
            // åŠ è½½ç…§ç‰‡
            loadPhotos();
        });
        
        function loadSingleViolationPhotos(recordId) {
            // åªé‡æ–°åŠ è½½æŒ‡å®šè®°å½•çš„ç…§ç‰‡
            const licensePlate = encodeURIComponent('{{ license_plate }}');
            fetch(`/api/violations?license_plate=${licensePlate}`)
                .then(response => response.json())
                .then(data => {
                    const violation = data.find(v => v.id == recordId);
                    if (violation) {
                        const index = data.findIndex(v => v.id == recordId);
                        const container = document.getElementById(`photo-container-${index + 1}`);
                        if (container) {
                            // å…ˆæ¸…ç©ºå®¹å™¨
                            container.innerHTML = '';
                            
                            if (violation.photo_path) {
                                try {
                                    const photoPaths = JSON.parse(violation.photo_path);
                                    if (Array.isArray(photoPaths)) {
                                        photoPaths.forEach((path, pathIndex) => {
                                            const img = document.createElement('img');
                                            img.src = '/' + path;
                                            img.alt = `è¿åœç…§ç‰‡${pathIndex + 1}`;
                                            img.className = 'photo';
                                            img.style.marginBottom = '10px';
                                            img.onerror = function() { 
                                                this.style.display = 'none';
                                                const errorMsg = document.createElement('div');
                                                errorMsg.className = 'no-photo';
                                                errorMsg.textContent = 'ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥';
                                                errorMsg.style.marginBottom = '10px';
                                                this.parentNode.insertBefore(errorMsg, this);
                                            };
                                            img.onclick = function() { openModal(this.src); };
                                            container.appendChild(img);
                                        });
                                    } else {
                                        const img = document.createElement('img');
                                        img.src = '/' + violation.photo_path;
                                        img.alt = 'è¿åœç…§ç‰‡';
                                        img.className = 'photo';
                                        img.onerror = function() { 
                                            this.style.display = 'none';
                                            const errorMsg = document.createElement('div');
                                            errorMsg.className = 'no-photo';
                                            errorMsg.textContent = 'ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥';
                                            this.parentNode.insertBefore(errorMsg, this);
                                        };
                                        img.onclick = function() { openModal(this.src); };
                                        container.appendChild(img);
                                    }
                                } catch (e) {
                                    const img = document.createElement('img');
                                    img.src = '/' + violation.photo_path;
                                    img.alt = 'è¿åœç…§ç‰‡';
                                    img.className = 'photo';
                                    img.onerror = function() { 
                                        this.style.display = 'none';
                                        const errorMsg = document.createElement('div');
                                        errorMsg.className = 'no-photo';
                                        errorMsg.textContent = 'ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥';
                                        this.parentNode.insertBefore(errorMsg, this);
                                    };
                                    img.onclick = function() { openModal(this.src); };
                                    container.appendChild(img);
                                }
                            } else {
                                container.innerHTML = '<div class="no-photo">ğŸ“· æ— ç…§ç‰‡</div>';
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('é‡æ–°åŠ è½½ç…§ç‰‡å¤±è´¥:', error);
                });
        }
        
        function loadPhotos() {
            // ä»åç«¯è·å–è¿è§„æ•°æ®æ¥å¤„ç†ç…§ç‰‡
            const licensePlate = encodeURIComponent('{{ license_plate }}');
            fetch(`/api/violations?license_plate=${licensePlate}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach((violation, index) => {
                        const container = document.getElementById(`photo-container-${index + 1}`);
                        if (container) {
                            // å…ˆæ¸…ç©ºå®¹å™¨ï¼Œé¿å…é‡å¤æ˜¾ç¤º
                            container.innerHTML = '';
                            
                            if (violation.photo_path) {
                                try {
                                    // å°è¯•è§£æJSON
                                    const photoPaths = JSON.parse(violation.photo_path);
                                    if (Array.isArray(photoPaths)) {
                                        // å¤šå¼ ç…§ç‰‡
                                        photoPaths.forEach((path, pathIndex) => {
                                            const img = document.createElement('img');
                                            img.src = '/' + path;
                                            img.alt = `è¿åœç…§ç‰‡${pathIndex + 1}`;
                                            img.className = 'photo';
                                            img.style.marginBottom = '10px';
                                            img.onerror = function() { 
                                                this.style.display = 'none';
                                                const errorMsg = document.createElement('div');
                                                errorMsg.className = 'no-photo';
                                                errorMsg.textContent = 'ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥';
                                                errorMsg.style.marginBottom = '10px';
                                                this.parentNode.insertBefore(errorMsg, this);
                                            };
                                            img.onclick = function() { openModal(this.src); };
                                            container.appendChild(img);
                                        });
                                    } else {
                                        // å•å¼ ç…§ç‰‡
                                        const img = document.createElement('img');
                                        img.src = '/' + violation.photo_path;
                                        img.alt = 'è¿åœç…§ç‰‡';
                                        img.className = 'photo';
                                        img.onerror = function() { 
                                            this.style.display = 'none';
                                            const errorMsg = document.createElement('div');
                                            errorMsg.className = 'no-photo';
                                            errorMsg.textContent = 'ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥';
                                            this.parentNode.insertBefore(errorMsg, this);
                                        };
                                        img.onclick = function() { openModal(this.src); };
                                        container.appendChild(img);
                                    }
                                } catch (e) {
                                    // ä¸æ˜¯JSONæ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºå•å¼ ç…§ç‰‡
                                    const img = document.createElement('img');
                                    img.src = '/' + violation.photo_path;
                                    img.alt = 'è¿åœç…§ç‰‡';
                                    img.className = 'photo';
                                    img.onerror = function() { 
                                        this.style.display = 'none';
                                        const errorMsg = document.createElement('div');
                                        errorMsg.className = 'no-photo';
                                        errorMsg.textContent = 'ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥';
                                        this.parentNode.insertBefore(errorMsg, this);
                                    };
                                    img.onclick = function() { openModal(this.src); };
                                    container.appendChild(img);
                                }
                            } else {
                                // æ²¡æœ‰å›¾ç‰‡
                                container.innerHTML = '<div class="no-photo">ğŸ“· æ— ç…§ç‰‡</div>';
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½ç…§ç‰‡å¤±è´¥:', error);
                });
        }
        
        // åˆ é™¤å•æ¡è®°å½•
        function deleteViolation(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¿åœè®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            fetch(`/api/violation/${recordId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    // åŠ¨æ€ç§»é™¤è¢«åˆ é™¤çš„å…ƒç´ è€Œä¸æ˜¯åˆ·æ–°æ•´ä¸ªé¡µé¢
                    const violationElement = document.getElementById(`violation-${recordId}`);
                    if (violationElement) {
                        violationElement.style.transition = 'opacity 0.3s';
                        violationElement.style.opacity = '0';
                        setTimeout(() => {
                            violationElement.remove();
                            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                            updateStatistics();
                        }, 300);
                    }
                } else {
                    showMessage(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            // è·å–å‰©ä½™è¿è§„æ¡ç›®æ•°
            const violationItems = document.querySelectorAll('.violation-item');
            const count = violationItems.length;
            
            // æ›´æ–°æ€»æ•°æ˜¾ç¤º
            const totalCountElement = document.querySelector('.stat-number');
            if (totalCountElement) {
                totalCountElement.textContent = count;
            }
            
            // æ›´æ–°è½¦è¾†é£é™©ç­‰çº§æ˜¾ç¤º
            const riskIndicator = document.querySelector('div[style*="border-radius: 20px"]');
            if (riskIndicator) {
                if (count >= 5) {
                    riskIndicator.innerHTML = 'âš ï¸ é«˜é¢‘è¿è§„è½¦è¾†';
                    riskIndicator.style.background = '#ffebee';
                    riskIndicator.style.color = '#c62828';
                } else if (count >= 3) {
                    riskIndicator.innerHTML = 'âš¡ ä¸­é¢‘è¿è§„è½¦è¾†';
                    riskIndicator.style.background = '#fff3e0';
                    riskIndicator.style.color = '#ef6c00';
                } else {
                    riskIndicator.innerHTML = 'âœ… ä½é¢‘è¿è§„è½¦è¾†';
                    riskIndicator.style.background = '#e8f5e8';
                    riskIndicator.style.color = '#2e7d32';
                }
            }
        }
        
        // åˆ é™¤è½¦ç‰Œçš„æ‰€æœ‰è®°å½•
        function deleteAllViolations(licensePlate) {
            const count = {{ total_count }};
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è½¦ç‰Œ ${licensePlate} çš„æ‰€æœ‰ ${count} æ¡è¿åœè®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            if (!confirm('ã€é‡è¦æé†’ã€‘åˆ é™¤åè¯¥è½¦ç‰Œçš„æ‰€æœ‰è®°å½•å°†æ°¸ä¹…æ¶ˆå¤±ï¼\n\nè¯·ç‚¹å‡»"ç¡®å®š"ç¡®è®¤åˆ é™¤ï¼Œæˆ–ç‚¹å‡»"å–æ¶ˆ"ä¸­æ­¢æ“ä½œã€‚')) {
                return;
            }
            
            const encodedPlate = encodeURIComponent(licensePlate);
            
            fetch(`/api/vehicle/${encodedPlate}`, {
                method: 'DELETE'
                })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message || `æˆåŠŸåˆ é™¤è½¦ç‰Œ ${licensePlate} çš„æ‰€æœ‰è®°å½•`, 'success');
                    // 2ç§’åè·³è½¬åˆ°ä¸»é¡µ
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    showMessage(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type) {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            
            if (type === 'success') {
                messageDiv.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
            } else if (type === 'info') {
                messageDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            } else {
                messageDiv.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 3000);
        }
        
        // å›¾ç‰‡æ“ä½œç›¸å…³å‡½æ•°
        function previewNewImage(recordId) {
            const fileInput = document.getElementById(`new-image-${recordId}`);
            const previewDiv = document.getElementById(`new-image-preview-${recordId}`);
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 4px; margin-bottom: 5px;">
                        <div style="font-size: 12px; color: #666;">æ–°å›¾ç‰‡é¢„è§ˆ</div>
                    `;
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        }
        
        function loadExistingImages(recordId) {
            const container = document.getElementById(`existing-images-${recordId}`);
            
            // å…ˆä»é¡µé¢ä¸­è·å–ç°æœ‰çš„å›¾ç‰‡ä¿¡æ¯
            const violationElement = document.getElementById(`violation-${recordId}`);
            const photoContainer = violationElement.querySelector('.photo-container');
            const images = photoContainer.querySelectorAll('img');
            
            if (images.length > 0) {
                let html = '';
                images.forEach((img, index) => {
                    const imgSrc = img.src;
                    // æ›´å¥½åœ°æå–æ–‡ä»¶åï¼Œå¤„ç†URLç¼–ç çš„æƒ…å†µ
                    let imgName = imgSrc.split('/').pop() || `å›¾ç‰‡${index + 1}`;
                    // å¦‚æœæ˜¯å®Œæ•´çš„URLï¼Œå»æ‰æŸ¥è¯¢å‚æ•°
                    imgName = imgName.split('?')[0];
                    // å¦‚æœæ–‡ä»¶åå¤ªé•¿ï¼Œæˆªå–å‰30ä¸ªå­—ç¬¦
                    if (imgName.length > 30) {
                        imgName = imgName.substring(0, 27) + '...';
                    }
                    html += `
                        <div class="image-item">
                            <div class="image-info">
                                <img src="${imgSrc}" class="image-preview" alt="å›¾ç‰‡${index + 1}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display:none;" class="no-photo">ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                                <span class="image-name" title="${imgName}">${imgName}</span>
                            </div>
                            <div class="image-actions">
                                <button class="rename-btn" onclick="renameImage(${recordId}, '${imgSrc}', ${index})">é‡å‘½å</button>
                                <button class="delete-image-btn" onclick="deleteImage(${recordId}, '${imgSrc}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div style="font-size: 12px; color: #999; text-align: center; padding: 10px;">æš‚æ— å›¾ç‰‡</div>';
            }
        }
        
        function renameImage(recordId, imagePath, imageIndex) {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„å›¾ç‰‡åç§°ï¼ˆä¸å«æ‰©å±•åï¼‰ï¼š');
            if (newName && newName.trim()) {
                // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ–°åç§°ä¸åŒ…å«å±é™©å­—ç¬¦
                if (newName.includes('/') || newName.includes('\\') || newName.includes('..')) {
                    showMessage('æ–‡ä»¶åä¸èƒ½åŒ…å« / \\ .. ç­‰å­—ç¬¦', 'error');
                    return;
                }
                
                // å°†å®Œæ•´URLè½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
                let relativePath = imagePath;
                let baseUrl = '';
                if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                    try {
                        const url = new URL(imagePath);
                        relativePath = url.pathname;
                        baseUrl = url.origin;
                    } catch (e) {
                        console.error('URLè§£æå¤±è´¥:', e);
                        showMessage('å›¾ç‰‡è·¯å¾„è§£æå¤±è´¥', 'error');
                        return;
                    }
                }
                
                // ç§»é™¤å¼€å¤´çš„æ–œæ 
                if (relativePath.startsWith('/')) {
                    relativePath = relativePath.substring(1);
                }
                
                // è·å–æ–‡ä»¶æ‰©å±•å
                const originalName = relativePath.split('/').pop();
                const fileExt = originalName.split('.').pop();
                
                // æ„å»ºæ–°çš„æ–‡ä»¶å
                const newFileName = newName.trim() + '.' + fileExt;
                const newPath = relativePath.replace(originalName, newFileName);
                
                showMessage('æ­£åœ¨é‡å‘½åå›¾ç‰‡...', 'info');
                
                // å‘é€é‡å‘½åè¯·æ±‚åˆ°åç«¯
                const formData = new FormData();
                formData.append('record_id', recordId);
                formData.append('old_path', relativePath);
                formData.append('new_path', newPath);
                
                fetch('/api/rename_image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ›´æ–°æ˜¾ç¤º
                        const imageItems = document.querySelectorAll(`#existing-images-${recordId} .image-item`);
                        if (imageItems[imageIndex]) {
                            const nameElement = imageItems[imageIndex].querySelector('.image-name');
                            const imgElement = imageItems[imageIndex].querySelector('.image-preview');
                            
                            if (nameElement) {
                                nameElement.textContent = newFileName;
                                nameElement.title = newFileName;
                            }
                            
                            // æ›´æ–°å›¾ç‰‡src
                            if (imgElement) {
                                const newUrl = baseUrl ? `${baseUrl}/${newPath}` : `/${newPath}`;
                                imgElement.src = newUrl;
                            }
                            
                            // æ›´æ–°åˆ é™¤æŒ‰é’®çš„onclickå±æ€§
                            const deleteBtn = imageItems[imageIndex].querySelector('.delete-image-btn');
                            if (deleteBtn) {
                                deleteBtn.setAttribute('onclick', `deleteImage(${recordId}, '${newUrl}')`);
                            }
                            
                            // æ›´æ–°é‡å‘½åæŒ‰é’®çš„onclickå±æ€§
                            const renameBtn = imageItems[imageIndex].querySelector('.rename-btn');
                            if (renameBtn) {
                                renameBtn.setAttribute('onclick', `renameImage(${recordId}, '${newUrl}', ${imageIndex})`);
                            }
                        }
                        
                        showMessage('å›¾ç‰‡é‡å‘½åæˆåŠŸ', 'success');
                        
                        // é‡æ–°åŠ è½½è¯¥è®°å½•çš„ç…§ç‰‡æ˜¾ç¤ºä»¥ç¡®ä¿åŒæ­¥
                        setTimeout(() => {
                            loadSingleViolationPhotos(recordId);
                        }, 500);
                        
                        // å¦‚æœæœ‰è­¦å‘Šä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤º
                        if (data.warning) {
                            showMessage(data.message, 'info');
                        }
                    } else {
                        showMessage('é‡å‘½åå¤±è´¥: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('é‡å‘½åå›¾ç‰‡å¤±è´¥:', error);
                    showMessage('é‡å‘½åå›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
            }
        }
        
        function deleteImage(recordId, imagePath) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                showMessage('æ­£åœ¨åˆ é™¤å›¾ç‰‡...', 'info');
                
                // å°†å®Œæ•´URLè½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
                let relativePath = imagePath;
                if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                    try {
                        // ä½¿ç”¨URLå¯¹è±¡æ›´å®‰å…¨åœ°æå–è·¯å¾„éƒ¨åˆ†
                        const url = new URL(imagePath);
                        relativePath = url.pathname;
                    } catch (e) {
                        console.error('URLè§£æå¤±è´¥:', e);
                        showMessage('å›¾ç‰‡è·¯å¾„è§£æå¤±è´¥', 'error');
                        return;
                    }
                }
                
                // å»æ‰å¼€å¤´çš„æ–œæ 
                if (relativePath.startsWith('/')) {
                    relativePath = relativePath.substring(1);
                }
                
                // æ„å»ºFormDataå‘é€åˆ é™¤è¯·æ±‚
                const formData = new FormData();
                formData.append('record_id', recordId);
                formData.append('image_path', relativePath);
                
                fetch('/api/delete_image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ä»æ˜¾ç¤ºä¸­ç§»é™¤å›¾ç‰‡
                        const imageItems = document.querySelectorAll(`#existing-images-${recordId} .image-item`);
                        imageItems.forEach(item => {
                            const img = item.querySelector('.image-preview');
                            if (img && (img.src === imagePath || img.src.endsWith(relativePath))) {
                                item.remove();
                                showMessage('å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'success');
                                // é‡æ–°åŠ è½½è¯¥è®°å½•çš„ç…§ç‰‡æ˜¾ç¤º
                                setTimeout(() => {
                                    loadSingleViolationPhotos(recordId);
                                }, 500);
                                return;
                            }
                        });
                        
                        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å›¾ç‰‡
                        const remainingImages = document.querySelectorAll(`#existing-images-${recordId} .image-item`);
                        if (remainingImages.length === 0) {
                            document.getElementById(`existing-images-${recordId}`).innerHTML = '<div style="font-size: 12px; color: #999; text-align: center; padding: 10px;">æš‚æ— å›¾ç‰‡</div>';
                        }
                        
                        // å¦‚æœæœ‰è­¦å‘Šä¿¡æ¯ï¼Œåˆ™æ˜¾ç¤º
                        if (data.warning) {
                            showMessage(data.message, 'info');
                        }
                    } else {
                        showMessage('åˆ é™¤å¤±è´¥: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                    showMessage('åˆ é™¤å›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                });
            }
        }
        
        // ç¼–è¾‘æ¨¡å¼ç›¸å…³å‡½æ•°
        function enterEditMode(recordId) {
            // éšè—æ˜¾ç¤ºå…ƒç´ ï¼Œæ˜¾ç¤ºç¼–è¾‘è¡¨å•
            document.getElementById(`type-display-${recordId}`).style.display = 'none';
            document.getElementById(`time-display-${recordId}`).style.display = 'none';
            
            const descDisplay = document.getElementById(`description-display-${recordId}`);
            if (descDisplay) {
                descDisplay.style.display = 'none';
            }
            
            // åŠ è½½ç°æœ‰å›¾ç‰‡
            loadExistingImages(recordId);
            
            document.getElementById(`edit-form-${recordId}`).style.display = 'block';
            document.getElementById(`action-buttons-${recordId}`).style.display = 'none';
            document.getElementById(`edit-buttons-${recordId}`).style.display = 'flex';
            
            // æ»šåŠ¨åˆ°ç¼–è¾‘åŒºåŸŸ
            document.getElementById(`violation-${recordId}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function cancelEdit(recordId) {
            // æ¢å¤æ˜¾ç¤ºå…ƒç´ ï¼Œéšè—ç¼–è¾‘è¡¨å•
            document.getElementById(`type-display-${recordId}`).style.display = 'inline-block';
            document.getElementById(`time-display-${recordId}`).style.display = 'block';
            
            const descDisplay = document.getElementById(`description-display-${recordId}`);
            if (descDisplay) {
                descDisplay.style.display = 'block';
            }
            
            document.getElementById(`edit-form-${recordId}`).style.display = 'none';
            document.getElementById(`action-buttons-${recordId}`).style.display = 'flex';
            document.getElementById(`edit-buttons-${recordId}`).style.display = 'none';
        }
        
        function saveViolation(recordId) {
            // è·å–ç¼–è¾‘åçš„å€¼
            const violationType = document.getElementById(`type-input-${recordId}`).value;
            const location = document.getElementById(`location-input-${recordId}`).value.trim();
            const description = document.getElementById(`description-input-${recordId}`).value.trim();
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!location) {
                showMessage('è¯·è¾“å…¥è¿è§„åœ°ç‚¹', 'error');
                document.getElementById(`location-input-${recordId}`).focus();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å›¾ç‰‡è¦ä¸Šä¼ 
            const newImageInput = document.getElementById(`new-image-${recordId}`);
            const hasNewImage = newImageInput && newImageInput.files && newImageInput.files.length > 0;
            
            if (hasNewImage) {
                // å¦‚æœæœ‰æ–°å›¾ç‰‡ï¼Œå…ˆä¸Šä¼ å›¾ç‰‡
                const formData = new FormData();
                formData.append('image', newImageInput.files[0]);
                formData.append('record_id', recordId);
                
                showMessage('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...', 'info');
                
                fetch('/api/upload_image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(uploadData => {
                    if (uploadData.success) {
                        console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', uploadData);
                        // å›¾ç‰‡ä¸Šä¼ æˆåŠŸåï¼Œæ›´æ–°æ–‡æœ¬ä¿¡æ¯
                        updateViolationData(recordId, violationType, location, description);
                    } else {
                        showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + uploadData.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                    showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'error');
                });
            } else {
                // æ²¡æœ‰æ–°å›¾ç‰‡ï¼Œç›´æ¥æ›´æ–°æ–‡æœ¬ä¿¡æ¯
                updateViolationData(recordId, violationType, location, description);
            }
        }
        
        function updateViolationData(recordId, violationType, location, description) {
            // æ„å»ºæ›´æ–°æ•°æ®
            const updateData = {
                violation_type: violationType,
                location: location
            };
            
            if (description) {
                updateData.description = description;
            }
            
            // å‘é€æ›´æ–°è¯·æ±‚
            console.log('æ­£åœ¨å‘é€æ›´æ–°è¯·æ±‚:', updateData);
            fetch(`/api/violation/${recordId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => {
                console.log('æ”¶åˆ°å“åº”:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('å“åº”æ•°æ®:', data);
                if (data.success) {
                    // æ›´æ–°æ˜¾ç¤ºå†…å®¹
                    document.getElementById(`type-display-${recordId}`).textContent = `ğŸš« ${violationType}`;
                    document.getElementById(`location-time-display-${recordId}`).textContent = `ğŸ“ ${location}`;
                    
                    const descDisplay = document.getElementById(`description-display-${recordId}`);
                    if (descDisplay) {
                        if (description) {
                            descDisplay.textContent = description;
                            descDisplay.style.display = 'block';
                        } else {
                            descDisplay.style.display = 'none';
                        }
                    }
                    
                    // é‡æ–°åŠ è½½å½“å‰è®°å½•çš„ç…§ç‰‡ä»¥æ˜¾ç¤ºæ–°ä¸Šä¼ çš„å›¾ç‰‡
                    setTimeout(() => {
                        loadSingleViolationPhotos(recordId);
                    }, 500);
                    
                    // é€€å‡ºç¼–è¾‘æ¨¡å¼
                    cancelEdit(recordId);
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage('è®°å½•æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    showMessage(data.message || 'æ›´æ–°å¤±è´¥', 'error');
                }
            })
            .catch(error => {
                console.error('æ›´æ–°å¤±è´¥:', error);
                showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            });
        }
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†å’Œé€€å‡ºç¼–è¾‘æ¨¡å¼
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç¼–è¾‘æ¨¡å¼æ¿€æ´»ï¼Œå¦‚æœæœ‰åˆ™é€€å‡º
                const editForms = document.querySelectorAll('[id^="edit-form-"]');
                editForms.forEach(form => {
                    if (form.style.display === 'block') {
                        const recordId = form.id.replace('edit-form-', '');
                        cancelEdit(recordId);
                    }
                });
            }
        });
    </script>
</body>
</html>