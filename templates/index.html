<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¦è¾†è¿åœè®°å½•ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 30px 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .nav-link {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #4facfe;
            text-decoration: none;
            font-size: 14px;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            white-space: pre-line;
            text-align: left;
            line-height: 1.4;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* æˆåŠŸå¼¹çª—æ ·å¼ */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .success-modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
        }
        
        .success-modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 0.6s ease;
        }
        
        .success-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .success-modal-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .success-modal-countdown {
            font-size: 14px;
            color: #4facfe;
            font-weight: 600;
        }
        
        .compressed-preview {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .multi-image-preview {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .preview-stats {
            margin-bottom: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .stat-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .total-original { color: #dc3545; }
        .total-compressed { color: #28a745; }
        .total-saved { color: #007bff; }
        .total-ratio { color: #fd7e14; }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .image-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .image-item .preview-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .image-info {
            font-size: 12px;
        }
        
        .image-info .filename {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            word-break: break-all;
        }
        
        .image-info .size-info {
            color: #6c757d;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .preview-header h4 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        
        .remove-preview {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }
        
        .remove-preview:hover {
            background: #c82333;
        }
        
        .preview-content {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .preview-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            border: 1px solid #ddd;
            object-fit: cover;
        }
        
        .preview-info {
            flex: 1;
        }
        
        .preview-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .preview-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 16px;
            font-weight: bold;
        }
        
        .stat-value.original {
            color: #dc3545;
        }
        
        .stat-value.compressed {
            color: #28a745;
        }
        
        .stat-arrow {
            font-size: 20px;
            color: #007bff;
            font-weight: bold;
            margin: 0 10px;
        }
        
        .compression-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #e9ecef;
            border-radius: 6px;
        }
        
        .saved-space {
            font-weight: bold;
            color: #007bff;
        }
        
        .compression-badge {
            text-align: center;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .success-modal-close {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 10px;
        }
        
        .success-modal-close:hover {
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }
        
        .camera-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            margin-bottom: 20px;
        }
        
        .license-plate-input {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— è½¦è¾†è¿åœè®°å½•</h1>
            <p>è®°å½•è¿è§„åœè½¦ï¼Œç»´æŠ¤äº¤é€šç§©åº</p>
        </div>
        
        <div class="form-container">
            <div id="message" class="message"></div>
            
            <form id="violationForm">
                <div class="form-group">
                    <label for="license_plate">è½¦ç‰Œå·ç </label>
                    <div style="display: flex; gap: 8px;">
                        <!-- ç¬¬ä¸€æ ¼ï¼šçœä»½ä¸­æ–‡ -->
                        <select id="province_prefix" name="province_prefix" required 
                                style="flex: 0 0 80px; font-size: 18px; font-weight: bold; text-align: center; padding: 12px; order: 1;"
                                onchange="updateLicensePlateValidation()">
                            <option value="äº¬">äº¬</option>
                            <option value="æ´¥">æ´¥</option>
                            <option value="å†€">å†€</option>
                            <option value="æ™‹">æ™‹</option>
                            <option value="è’™">è’™</option>
                            <option value="è¾½">è¾½</option>
                            <option value="å‰">å‰</option>
                            <option value="é»‘">é»‘</option>
                            <option value="æ²ª">æ²ª</option>
                            <option value="è‹">è‹</option>
                            <option value="æµ™">æµ™</option>
                            <option value="çš–">çš–</option>
                            <option value="é—½">é—½</option>
                            <option value="èµ£">èµ£</option>
                            <option value="é²">é²</option>
                            <option value="è±«">è±«</option>
                            <option value="é„‚" selected>é„‚</option>
                            <option value="æ¹˜">æ¹˜</option>
                            <option value="ç²¤">ç²¤</option>
                            <option value="æ¡‚">æ¡‚</option>
                            <option value="ç¼">ç¼</option>
                            <option value="æ¸">æ¸</option>
                            <option value="å·">å·</option>
                            <option value="è´µ">è´µ</option>
                            <option value="äº‘">äº‘</option>
                            <option value="è—">è—</option>
                            <option value="é™•">é™•</option>
                            <option value="ç”˜">ç”˜</option>
                            <option value="é’">é’</option>
                            <option value="å®">å®</option>
                            <option value="æ–°">æ–°</option>
                            <option value="ç‰¹æ®Š">ç‰¹æ®Šè½¦ç‰Œ</option>
                        </select>
                        
                        <!-- ç¬¬äºŒæ ¼ï¼šè‹±æ–‡å­—æ¯ä¸‹æ‹‰ -->
                        <select id="letter_prefix" name="letter_prefix" required 
                                style="flex: 0 0 70px; font-size: 18px; font-weight: bold; text-align: center; padding: 12px; order: 2;"
                                onchange="updateLicensePlateValidation()">
                            <option value="A" selected>A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="G">G</option>
                            <option value="H">H</option>
                            <option value="J">J</option>
                            <option value="K">K</option>
                            <option value="L">L</option>
                            <option value="M">M</option>
                            <option value="N">N</option>
                            <option value="P">P</option>
                            <option value="Q">Q</option>
                            <option value="R">R</option>
                            <option value="S">S</option>
                            <option value="T">T</option>
                            <option value="U">U</option>
                            <option value="V">V</option>
                            <option value="W">W</option>
                            <option value="X">X</option>
                            <option value="Y">Y</option>
                            <option value="Z">Z</option>
                        </select>
                        
                        <!-- ç¬¬ä¸‰æ ¼ï¼š5-6ä½æ•°å­—æˆ–å­—æ¯ -->
                        <input type="text" id="license_plate" name="license_plate" 
                               class="license-plate-input" value="12345" required 
                               style="flex: 1; font-size: 18px; font-weight: bold; text-align: center; text-transform: uppercase; order: 3;"
                               oninput="updateLicensePlateValidation()"
                               onkeypress="return validateKeyPress(event)"
                               maxlength="6"
                               placeholder="12345"
                               onfocus="this.select()">
                    </div>
                    <div id="plateHelp" style="font-size: 12px; color: #666; margin-top: 5px;">
                        è¯·è¾“å…¥5-6ä½æ•°å­—æˆ–å­—æ¯å¤§å†™ï¼ˆå¦‚ï¼š12345æˆ–A1B2C3ï¼‰
                    </div>
                </div>
                

                
                <div class="form-group">
                    <label for="location">è¿åœåœ°ç‚¹</label>
                    <input type="text" id="location" name="location" 
                           placeholder="Please input å…·ä½“è¿åœåœ°ç‚¹" required>
                </div>
                
                <div class="form-group">
                    <label for="violation_time">è¿è§„æ—¶é—´</label>
                    <input type="datetime-local" id="violation_time" name="violation_time" required>
                </div>
                
                <div class="form-group">
                    <label for="violation_type">è¿åœç±»å‹</label>
                    <select id="violation_type" name="violation_type" required>
                        <option value="">Please select è¿åœç±»å‹</option>
                        <option value="å ç”¨æ¶ˆé˜²é€šé“">å ç”¨æ¶ˆé˜²é€šé“</option>
                        <option value="å ç”¨äººè¡Œé“">å ç”¨äººè¡Œé“</option>
                        <option value="é€†å‘åœè½¦">é€†å‘åœè½¦</option>
                        <option value="å‹çº¿åœè½¦">å‹çº¿åœè½¦</option>
                        <option value="ç¦æ­¢åœè½¦åŒºåŸŸ">ç¦æ­¢åœè½¦åŒºåŸŸ</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                

                
                <div class="form-group">
                    <label for="description">è¯¦ç»†æè¿°</label>
                    <textarea id="description" name="description" 
                              placeholder="Please describe è¿åœçš„å…·ä½“æƒ…å†µ..."></textarea>
                </div>
                
                <input type="file" id="photoInput" name="photo" accept="image/*" multiple style="display: none;" onchange="handlePhotoSelect(this)">
                
                <button type="button" class="btn camera-btn" onclick="document.getElementById('photoInput').click()">
                    ğŸ“· é€‰æ‹©ç…§ç‰‡
                </button>
                
                <!-- æ·»åŠ ä¸Šä¼ æŒ‰é’® -->
                <button type="button" class="btn upload-btn" id="uploadButton" onclick="uploadSelectedPhotos()" style="display: none; background: linear-gradient(135deg, #28a745 0%, #218838 100%);">
                    ğŸ“¤ ä¸Šä¼ ç…§ç‰‡
                </button>
                
                <button type="submit" class="btn">
                    æäº¤è¿åœè®°å½•
                </button>
            </form>
            
            <a href="/" class="nav-link">â† è¿”å›è®°å½•åˆ—è¡¨</a>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¹‹å‰çš„è½¦ç‰Œå·å’Œè®¾ç½®é»˜è®¤æ—¶é—´
        window.addEventListener('DOMContentLoaded', function() {
            const savedPlate = localStorage.getItem('lastLicensePlate');
            const savedProvince = localStorage.getItem('lastProvince');
            const savedLetter = localStorage.getItem('lastLetter');
            
            if (savedPlate && savedProvince) {
                document.getElementById('license_plate').value = savedPlate;
                document.getElementById('province_prefix').value = savedProvince;
                
                if (savedLetter) {
                    document.getElementById('letter_prefix').value = savedLetter;
                }
                
                updateLicensePlateValidation();
            }
            
            // è®¾ç½®é»˜è®¤è¿è§„æ—¶é—´ä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const defaultDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('violation_time').value = defaultDateTime;
        });
        
        document.getElementById('violationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // é˜²æ­¢é‡å¤æäº¤
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton.classList.contains('submitting')) {
                console.log('æäº¤å·²åœ¨è¿›è¡Œä¸­ï¼Œé˜»æ­¢é‡å¤æäº¤');
                return; // å¦‚æœæŒ‰é’®å·²æ ‡è®°ä¸ºæäº¤ä¸­ï¼Œè¯´æ˜æ­£åœ¨æäº¤ä¸­ï¼Œç›´æ¥è¿”å›
            }
            
            const provincePrefix = document.getElementById('province_prefix').value;
            const letterPrefix = document.getElementById('letter_prefix').value;
            const licensePlate = document.getElementById('license_plate').value;
            
            if (!provincePrefix) {
                showMessage('è¯·é€‰æ‹©çœä»½', 'error');
                return;
            }
            
            if (provincePrefix !== 'ç‰¹æ®Š' && !letterPrefix) {
                showMessage('è¯·é€‰æ‹©å­—æ¯', 'error');
                return;
            }
            
            if (!licensePlate) {
                showMessage('è¯·è¾“å…¥è½¦ç‰Œå·ç ', 'error');
                return;
            }
            
            let fullLicensePlate;
            
            if (provincePrefix === 'ç‰¹æ®Š') {
                // ç‰¹æ®Šè½¦ç‰Œï¼šçœä»½ + ç¬¬ä¸‰æ ¼å†…å®¹
                fullLicensePlate = provincePrefix + licensePlate;
            } else {
                // æ™®é€šè½¦ç‰Œï¼šçœä»½ + å­—æ¯ + ç¬¬ä¸‰æ ¼å†…å®¹
                // éªŒè¯è½¦ç‰Œé•¿åº¦ï¼ˆç¬¬ä¸‰æ ¼5-6ä½ï¼‰
                if (licensePlate.length < 5 || licensePlate.length > 6) {
                    showMessage('è½¦ç‰Œå·ç åº”ä¸º5-6ä½', 'error');
                    return;
                }
                
                fullLicensePlate = provincePrefix + letterPrefix + licensePlate;
                
                // å‰ç«¯æ ¼å¼éªŒè¯ - åªåšåŸºç¡€æ£€æŸ¥ï¼Œå…·ä½“çš„æ ¼å¼éªŒè¯äº¤ç»™åç«¯
                if (fullLicensePlate.length < 7) {
                    showMessage('è½¦ç‰Œå·ç æ ¼å¼ä¸å®Œæ•´', 'error');
                    return;
                }
            }
            
            // ç¦ç”¨æäº¤æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            submitButton.disabled = true;
            submitButton.classList.add('submitting');
            const originalButtonText = submitButton.innerHTML;
            submitButton.innerHTML = 'æäº¤ä¸­...';
            
            const formData = new FormData(this);
            // ä¿ç•™åŸå§‹çš„license_plateå­—æ®µç”¨äºè·å–locationç­‰å€¼
            formData.set('license_plate', fullLicensePlate);
            formData.delete('province_prefix');
            formData.delete('letter_prefix');
            
            // ç¡®ä¿è¿è§„æ—¶é—´è¢«æ­£ç¡®æ·»åŠ 
            const violationTime = document.getElementById('violation_time').value;
            if (violationTime) {
                formData.set('violation_time', violationTime);
            }
            
            // æ·»åŠ å¤šå¼ ç…§ç‰‡æ–‡ä»¶åˆ°FormDataï¼ˆä¼˜å…ˆä½¿ç”¨å‹ç¼©åçš„æ–‡ä»¶ï¼‰
            if (compressedImages.length > 0) {
                // æ·»åŠ å¤šå¼ å‹ç¼©åçš„å›¾ç‰‡è·¯å¾„
                compressedImages.forEach(img => {
                    formData.append('compressed_photos', img.path);
                });
            } else if (window.compressedFilePath) {
                // å•å¼ å‹ç¼©å›¾ç‰‡ï¼ˆå‘åå…¼å®¹ï¼‰
                formData.append('compressed_photo_path', window.compressedFilePath);
            } else if (window.selectedFiles && window.selectedFiles.length > 0) {
                // ç›´æ¥ä¸Šä¼ åŸå§‹æ–‡ä»¶ï¼ˆå¦‚æœæ²¡æœ‰å‹ç¼©ï¼‰
                const files = window.selectedFiles;
                files.forEach(file => {
                    formData.append('photo', file);
                });
            } else {
                // åŸå§‹æ–‡ä»¶ä¸Šä¼ 
                const photoInput = document.getElementById('photoInput');
                if (photoInput.files.length > 0) {
                    const files = Array.from(photoInput.files);
                    files.forEach(file => {
                        formData.append('photo', file);
                    });
                }
            }
            
            fetch('/submit_violation', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // æ¢å¤æäº¤æŒ‰é’®çŠ¶æ€
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('submitting');
                    submitButton.innerHTML = originalButtonText;
                }
                
                if (data.success) {
                    // ä¿å­˜å½“å‰è½¦ç‰Œå·åˆ°localStorage
                    const currentPlate = document.getElementById('license_plate').value;
                    const currentProvince = document.getElementById('province_prefix').value;
                    const currentLetter = document.getElementById('letter_prefix').value;
                    localStorage.setItem('lastLicensePlate', currentPlate);
                    localStorage.setItem('lastProvince', currentProvince);
                    localStorage.setItem('lastLetter', currentLetter);
                    
                    // æ¸…ç©ºå‹ç¼©å›¾ç‰‡ç¼“å­˜
                    compressedImages = [];
                    window.compressedFilePath = null;
                    window.selectedFiles = null; // æ¸…é™¤é€‰ä¸­çš„æ–‡ä»¶
                    
                    // éšè—ä¸Šä¼ æŒ‰é’®
                    const uploadButton = document.getElementById('uploadButton');
                    if (uploadButton) {
                        uploadButton.style.display = 'none';
                    }
                    
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
                    const photoInput = document.getElementById('photoInput');
                    if (photoInput) {
                        photoInput.value = '';
                    }
                    
                    // æ¸…ç©ºé¢„è§ˆåŒºåŸŸ
                    const imagePreview = document.getElementById('imagePreview');
                    const multiImagePreview = document.getElementById('multiImagePreview');
                    if (imagePreview) {
                        imagePreview.style.display = 'none';
                    }
                    if (multiImagePreview) {
                        multiImagePreview.style.display = 'none';
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showSuccessModal('ğŸ‰ è¿åœè®°å½•æäº¤æˆåŠŸï¼', data.message);
                    
                    // 3ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç»Ÿè®¡é¡µé¢
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    showMessage(data.message, 'error');
                }
            })
            .catch(error => {
                // æ¢å¤æäº¤æŒ‰é’®çŠ¶æ€
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('submitting');
                    submitButton.innerHTML = originalButtonText;
                }
                
                console.error('æäº¤è¯·æ±‚å¤±è´¥:', error);
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé—®é¢˜æˆ–å…¶ä»–é”™è¯¯
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showMessage('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', 'error');
                } else {
                    showMessage('æäº¤å¤±è´¥: ' + error.message + 'ï¼Œè¯·é‡è¯•', 'error');
                }
            });
        });
        
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
        
        function showSuccessModal(title, message) {
            // åˆ›å»ºå¼¹çª—å…ƒç´ 
            const modal = document.createElement('div');
            modal.className = 'success-modal';
            
            modal.innerHTML = `
                <div class="success-modal-content">
                    <div class="success-modal-icon">ğŸ‰</div>
                    <div class="success-modal-title">${title}</div>
                    <div class="success-modal-message">${message}</div>
                    <div class="success-modal-countdown">3ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç»Ÿè®¡é¡µé¢...</div>
                    <button class="success-modal-close" onclick="window.location.href='/'">ç«‹å³æŸ¥çœ‹ç»Ÿè®¡</button>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modal);
            
            // å€’è®¡æ—¶æ›´æ–°
            let countdown = 3;
            const countdownElement = modal.querySelector('.success-modal-countdown');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = `${countdown}ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç»Ÿè®¡é¡µé¢...`;
                } else {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆå¯é€‰ï¼‰
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                    clearInterval(countdownInterval);
                }
            });
        }
        
        function takePhoto() {
            const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
            
            if (!isSecureContext) {
                showAlternativeCameraOptions();
                return;
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlternativeCameraOptions();
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                createCameraModal(stream);
            })
            .catch(err => {
                console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', err);
                showAlternativeCameraOptions();
            });
        }
        
        function createCameraModal(stream) {
            const video = document.createElement('video');
            video.style.width = '100%';
            video.style.maxWidth = '400px';
            video.style.borderRadius = '10px';
            video.style.marginBottom = '20px';
            video.autoplay = true;
            video.srcObject = stream;
            
            const canvas = document.createElement('canvas');
            canvas.style.display = 'none';
            
            const captureBtn = document.createElement('button');
            captureBtn.textContent = 'ğŸ“¸ æ‹ç…§';
            captureBtn.className = 'btn';
            captureBtn.style.marginBottom = '10px';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'âŒ å–æ¶ˆ';
            cancelBtn.className = 'btn';
            cancelBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                padding: 20px;
            `;
            
            modal.appendChild(video);
            modal.appendChild(canvas);
            modal.appendChild(captureBtn);
            modal.appendChild(cancelBtn);
            document.body.appendChild(modal);
            
            captureBtn.onclick = function() {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0);
                
                stream.getTracks().forEach(track => track.stop());
                
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    showPhotoPreview(url, modal);
                }, 'image/jpeg', 0.8);
            };
            
            cancelBtn.onclick = function() {
                stream.getTracks().forEach(track => track.stop());
                document.body.removeChild(modal);
            };
        }
        
        function showPhotoPreview(url, modal) {
            const img = document.createElement('img');
            img.src = url;
            img.style.width = '100%';
            img.style.maxWidth = '300px';
            img.style.borderRadius = '10px';
            img.style.marginTop = '20px';
            
            modal.innerHTML = '';
            modal.appendChild(img);
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ç…§ç‰‡';
            saveBtn.className = 'btn';
            saveBtn.style.marginTop = '20px';
            saveBtn.onclick = function() {
                const a = document.createElement('a');
                a.href = url;
                a.download = `violation_${new Date().getTime()}.jpg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage('ç…§ç‰‡å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
                document.body.removeChild(modal);
                URL.revokeObjectURL(url);
            };
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'âŒ å…³é—­';
            closeBtn.className = 'btn';
            closeBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
            closeBtn.style.marginLeft = '10px';
            closeBtn.onclick = function() {
                document.body.removeChild(modal);
                URL.revokeObjectURL(url);
            };
            
            modal.appendChild(saveBtn);
            modal.appendChild(closeBtn);
        }
        
        function showAlternativeCameraOptions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                padding: 20px;
                color: white;
            `;
            
            modal.innerHTML = `
                <div style="background: white; color: #333; padding: 30px; border-radius: 15px; max-width: 400px; text-align: center;">
                    <h3 style="margin-bottom: 20px;">ğŸ“· ç›¸æœºåŠŸèƒ½ä¸å¯ç”¨</h3>
                    <p style="margin-bottom: 20px; line-height: 1.5;">
                        ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®ç›¸æœºã€‚è¯·å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š
                    </p>
                    <div style="text-align: left; margin-bottom: 20px;">
                        <p style="margin-bottom: 10px;">ğŸ“± <strong>æ‰‹æœºç”¨æˆ·ï¼š</strong></p>
                        <p style="margin-left: 20px; margin-bottom: 10px;">â€¢ ä½¿ç”¨ç³»ç»Ÿç›¸æœºæ‹ç…§åä¸Šä¼ </p>
                        <p style="margin-bottom: 10px;">ğŸ’» <strong>ç”µè„‘ç”¨æˆ·ï¼š</strong></p>
                        <p style="margin-left: 20px; margin-bottom: 10px;">â€¢ ç¡®ä¿ä½¿ç”¨HTTPSæˆ–localhost</p>
                        <p style="margin-left: 20px; margin-bottom: 10px;">â€¢ æ£€æŸ¥æµè§ˆå™¨ç›¸æœºæƒé™</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label for="fileUpload" style="display: inline-block; padding: 10px 20px; background: #4facfe; color: white; border-radius: 8px; cursor: pointer;">
                            ğŸ“ é€‰æ‹©ç…§ç‰‡ä¸Šä¼ 
                        </label>
                        <input type="file" id="fileUpload" accept="image/*" multiple style="display: none;" onchange="handleFileSelect(this)">
                    </div>
                    <button onclick="document.body.removeChild(this.closest('div').parentElement)" style="padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        å…³é—­
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file && file.type.startsWith('image/')) {
                showMessage(`å·²é€‰æ‹©ç…§ç‰‡: ${file.name}`, 'success');
            }
        }
        
        // å­˜å‚¨å¤šå¼ å‹ç¼©åçš„å›¾ç‰‡ä¿¡æ¯
        let compressedImages = [];
        
        // ä¸Šä¼ çŠ¶æ€æ§åˆ¶
        let isUploading = false;
        
        function handlePhotoSelect(input) {
            // æ¸…ç©ºä¹‹å‰çš„å‹ç¼©å›¾ç‰‡ç¼“å­˜
            compressedImages = [];
            window.compressedFilePath = null;
            
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            // éªŒè¯æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯å›¾ç‰‡
            const nonImageFiles = files.filter(file => !file.type.startsWith('image/'));
            if (nonImageFiles.length > 0) {
                showMessage('è¯·åªé€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                input.value = '';
                return;
            }
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶ä¿¡æ¯
            if (files.length === 1) {
                showMessage(`å·²é€‰æ‹©1å¼ å›¾ç‰‡: ${files[0].name}`, 'success');
            } else {
                showMessage(`å·²é€‰æ‹©${files.length}å¼ å›¾ç‰‡`, 'success');
            }
            
            // æ˜¾ç¤ºä¸Šä¼ æŒ‰é’®
            const uploadButton = document.getElementById('uploadButton');
            if (uploadButton) {
                uploadButton.style.display = 'block';
            }
            
            // ä¿å­˜é€‰ä¸­çš„æ–‡ä»¶åˆ°å…¨å±€å˜é‡ï¼Œä¾›ä¸Šä¼ æ—¶ä½¿ç”¨
            window.selectedFiles = files;
        }
        
        function uploadSelectedPhotos() {
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©æ–‡ä»¶
            if (!window.selectedFiles || window.selectedFiles.length === 0) {
                showMessage('è¯·å…ˆé€‰æ‹©ç…§ç‰‡', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸Šä¼ 
            if (isUploading) {
                showMessage('â³ æ­£åœ¨å¤„ç†å›¾ç‰‡ï¼Œè¯·ç­‰å¾…å®Œæˆåå†ä¸Šä¼ ', 'warning');
                return;
            }
            
            const files = window.selectedFiles;
            
            // è®¾ç½®ä¸Šä¼ çŠ¶æ€ä¸ºtrue
            isUploading = true;
            disableUploadControls(true);
            
            // éšè—ä¹‹å‰çš„é¢„è§ˆ
            const compressedPreview = document.getElementById('compressedPreview');
            const multiImagePreview = document.getElementById('multiImagePreview');
            if (compressedPreview) compressedPreview.style.display = 'none';
            if (multiImagePreview) multiImagePreview.style.display = 'none';
            
            // éšè—ä¸Šä¼ æŒ‰é’®
            const uploadButton = document.getElementById('uploadButton');
            if (uploadButton) {
                uploadButton.style.display = 'none';
            }
            
            if (files.length === 1) {
                // å•å¼ å›¾ç‰‡å¤„ç†ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                const file = files[0];
                showMessage(`æ­£åœ¨å‹ç¼©ç…§ç‰‡: ${file.name}...`, 'success');
                compressAndPreviewImage(file, 0, 1);
            } else {
                // å¤šå¼ å›¾ç‰‡å¤„ç† - é¡ºåºå¤„ç†
                showMessage(`å¼€å§‹å¤„ç† ${files.length} å¼ å›¾ç‰‡...`, 'success');
                processImagesSequentially(files, 0);
            }
        }
        
        function uploadSelectedPhotos() {
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ä¸Šä¼ 
            if (isUploading) {
                showMessage('â³ æ­£åœ¨å¤„ç†å›¾ç‰‡ï¼Œè¯·ç­‰å¾…å®Œæˆåå†ä¸Šä¼ ', 'warning');
                return;
            }
            
            const files = window.selectedFiles;
            if (!files || files.length === 0) {
                showMessage('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ç…§ç‰‡', 'error');
                return;
            }
            
            // è®¾ç½®ä¸Šä¼ çŠ¶æ€ä¸ºtrue
            isUploading = true;
            disableUploadControls(true);
            
            // æ¸…ç©ºä¹‹å‰çš„å‹ç¼©å›¾ç‰‡
            compressedImages = [];
            window.compressedFilePath = null;
            
            // éšè—ä¹‹å‰çš„é¢„è§ˆ
            const compressedPreview = document.getElementById('compressedPreview');
            const multiImagePreview = document.getElementById('multiImagePreview');
            if (compressedPreview) compressedPreview.style.display = 'none';
            if (multiImagePreview) multiImagePreview.style.display = 'none';
            
            if (files.length === 1) {
                // å•å¼ å›¾ç‰‡å¤„ç†ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                const file = files[0];
                showMessage(`æ­£åœ¨å‹ç¼©ç…§ç‰‡: ${file.name}...`, 'success');
                compressAndPreviewImage(file, 0, 1);
            } else {
                // å¤šå¼ å›¾ç‰‡å¤„ç† - é¡ºåºå¤„ç†
                showMessage(`å¼€å§‹å¤„ç† ${files.length} å¼ å›¾ç‰‡...`, 'success');
                processImagesSequentially(files, 0);
            }
        }
        
        function processImagesSequentially(files, currentIndex) {
            if (currentIndex >= files.length) {
                // æ‰€æœ‰å›¾ç‰‡å¤„ç†å®Œæˆ
                showMultiImagePreview();
                // é‡æ–°å¯ç”¨ä¸Šä¼ æ§ä»¶
                isUploading = false;
                disableUploadControls(false);
                return;
            }
            
            const file = files[currentIndex];
            compressAndPreviewImage(file, currentIndex, files.length, () => {
                // å¤„ç†å®Œå½“å‰å›¾ç‰‡åï¼Œå¤„ç†ä¸‹ä¸€å¼ 
                setTimeout(() => {
                    processImagesSequentially(files, currentIndex + 1);
                }, 300); // é—´éš”300ms
            });
        }
        
        function compressAndPreviewImage(file, index, total, callback) {
            const formData = new FormData();
            formData.append('file', file);
            
            // è·å–å®Œæ•´è½¦ç‰Œå·ï¼ˆåŒ…å«çœä»½å’Œå­—æ¯ï¼‰
            const provincePrefix = document.getElementById('province_prefix').value;
            const letterPrefix = document.getElementById('letter_prefix').value;
            const licensePlate = document.getElementById('license_plate').value.trim();
            
            let fullLicensePlate = '';
            if (provincePrefix === 'ç‰¹æ®Š') {
                fullLicensePlate = provincePrefix + licensePlate;
            } else if (licensePlate) {
                fullLicensePlate = provincePrefix + letterPrefix + licensePlate;
            }
            
            if (fullLicensePlate) {
                formData.append('license_plate', fullLicensePlate);
            }
            
            // æ˜¾ç¤ºå‹ç¼©è¿›åº¦
            showMessage(`æ­£åœ¨å‹ç¼©ç¬¬ ${index + 1} å¼ å›¾ç‰‡: ${file.name}`, 'success');
            
            fetch('/api/compress-preview', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ä¿å­˜å‹ç¼©åçš„å›¾ç‰‡ä¿¡æ¯
                    compressedImages.push({
                        path: data.compressed_path,
                        filename: data.filename,
                        original_size: data.original_size,
                        compressed_size: data.compressed_size,
                        compression_ratio: data.compression_ratio
                    });
                    
                    // æ˜¾ç¤ºå‹ç¼©å®Œæˆä¿¡æ¯
                    let compressionMessage = `âœ… ç¬¬ ${index + 1} å¼ å›¾ç‰‡å‹ç¼©å®Œæˆï¼\n`;
                    compressionMessage += `ğŸ“ æ–‡ä»¶å: ${data.filename}\n`;
                    compressionMessage += `ğŸ“Š ${data.original_size} â†’ ${data.compressed_size} (${data.compression_ratio})`;
                    
                    showMessage(compressionMessage, 'success');
                    
                    // å¦‚æœæ˜¯å•å¼ å›¾ç‰‡ï¼Œæ˜¾ç¤ºé¢„è§ˆ
                    if (!callback) {
                        showCompressedPreview(data);
                    }
                    
                    // å¦‚æœæ˜¯å•å¼ å›¾ç‰‡ï¼Œå¤„ç†å®Œæˆåé‡æ–°å¯ç”¨æ§ä»¶
                    if (!callback) {
                        isUploading = false;
                        disableUploadControls(false);
                    }
                    
                    // è°ƒç”¨å›è°ƒå‡½æ•°å¤„ç†ä¸‹ä¸€å¼ å›¾ç‰‡
                    if (callback) {
                        callback();
                    }
                } else {
                    showMessage(`âŒ ç¬¬ ${index + 1} å¼ å›¾ç‰‡å‹ç¼©å¤±è´¥: ${data.message}`, 'error');
                    // å‹ç¼©å¤±è´¥æ—¶ä¹Ÿè¦é‡æ–°å¯ç”¨æ§ä»¶
                    if (!callback) {
                        isUploading = false;
                        disableUploadControls(false);
                    }
                }
            })
            .catch(error => {
                showMessage(`âŒ ç¬¬ ${index + 1} å¼ å›¾ç‰‡å‹ç¼©å¤±è´¥: ${error.message}`, 'error');
                // å‹ç¼©å¤±è´¥æ—¶ä¹Ÿè¦é‡æ–°å¯ç”¨æ§ä»¶
                if (!callback) {
                    isUploading = false;
                    disableUploadControls(false);
                }
            });
        }
        
        // ç¦ç”¨/å¯ç”¨ä¸Šä¼ æ§ä»¶
        function disableUploadControls(disable) {
            // è·å–æ‰€æœ‰å¯èƒ½çš„DOMå…ƒç´ 
            const photoInput = document.getElementById('photoInput');
            const cameraBtn = document.querySelector('.camera-btn');
            const uploadBtn = document.getElementById('uploadButton');
            const pasteBtn = document.querySelector('.paste-btn');
            const dropZone = document.getElementById('dropZone');
            const submitBtn = document.querySelector('button[type="submit"]');
            
            // ç¦ç”¨/å¯ç”¨æ–‡ä»¶è¾“å…¥
            if (photoInput) {
                photoInput.disabled = disable;
            }
            
            // ç¦ç”¨/å¯ç”¨æŒ‰é’®
            if (cameraBtn) {
                cameraBtn.disabled = disable;
                cameraBtn.style.opacity = disable ? '0.6' : '1';
                cameraBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
            }
            
            if (uploadBtn) {
                uploadBtn.disabled = disable;
                uploadBtn.style.opacity = disable ? '0.6' : '1';
                uploadBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
            }
            
            if (pasteBtn) {
                pasteBtn.disabled = disable;
                pasteBtn.style.opacity = disable ? '0.6' : '1';
                pasteBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
            }
            
            // ç¦ç”¨/å¯ç”¨æ‹–æ‹½åŒºåŸŸ
            if (dropZone) {
                dropZone.style.opacity = disable ? '0.6' : '1';
                dropZone.style.pointerEvents = disable ? 'none' : 'auto';
                if (disable) {
                    dropZone.classList.remove('drag-over');
                }
            }
            
            // ç¦ç”¨/å¯ç”¨æäº¤æŒ‰é’®
            if (submitBtn) {
                // åªæœ‰åœ¨å¯ç”¨æ—¶æ‰ç§»é™¤æäº¤çŠ¶æ€ç±»ï¼Œç¦ç”¨æ—¶æ·»åŠ æäº¤çŠ¶æ€ç±»
                if (disable) {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('submitting');
                } else {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('submitting');
                }
                submitBtn.style.opacity = disable ? '0.6' : '1';
                submitBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
            }
            
            // æ›´æ–°æ‹–æ‹½åŒºåŸŸæ–‡æœ¬
            if (dropZone) {
                const dropText = dropZone.querySelector('.drop-text');
                const dropSubtext = dropZone.querySelector('.drop-subtext');
                
                if (disable) {
                    if (dropText) dropText.textContent = 'æ­£åœ¨å¤„ç†å›¾ç‰‡...';
                    if (dropSubtext) dropSubtext.textContent = 'è¯·ç­‰å¾…å¤„ç†å®Œæˆ';
                } else {
                    if (dropText) dropText.textContent = 'æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œä¸Šä¼ ';
                    if (dropSubtext) dropSubtext.textContent = 'æˆ–è€…ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶';
                }
            }
        }
        
        function showCompressedPreview(data) {
            // åˆ›å»ºæˆ–æ›´æ–°é¢„è§ˆåŒºåŸŸ
            let previewDiv = document.getElementById('compressedPreview');
            if (!previewDiv) {
                previewDiv = document.createElement('div');
                previewDiv.id = 'compressedPreview';
                previewDiv.className = 'compressed-preview';
                
                // æ’å…¥åˆ°ä¸Šä¼ æŒ‰é’®åé¢
                const uploadBtn = document.querySelector('.camera-btn');
                uploadBtn.parentNode.insertBefore(previewDiv, uploadBtn.nextSibling);
            }
            
            // è®¡ç®—æ›´è¯¦ç»†çš„æ•°æ®
            const originalMB = parseFloat(data.original_size);
            const compressedKB = parseFloat(data.compressed_size);
            const compressedMB = (compressedKB / 1024).toFixed(2);
            const savedMB = (originalMB - compressedKB/1024).toFixed(2);
            const savedRatio = parseFloat(data.compression_ratio);
            
            // æ ¹æ®å‹ç¼©ç‡è®¾ç½®é¢œè‰²
            let ratioColor = '#28a745'; // ç»¿è‰²
            if (savedRatio >= 90) {
                ratioColor = '#dc3545'; // çº¢è‰²è¡¨ç¤ºæé«˜å‹ç¼©
            } else if (savedRatio >= 70) {
                ratioColor = '#fd7e14'; // æ©™è‰²è¡¨ç¤ºé«˜å‹ç¼©
            }
            
            previewDiv.innerHTML = `
                <div class="preview-header">
                    <h4>ğŸ–¼ï¸ å‹ç¼©é¢„è§ˆ</h4>
                    <button class="remove-preview" onclick="removeCompressedPreview()">âœ•</button>
                </div>
                <div class="preview-content">
                    <img src="${data.compressed_url}" alt="å‹ç¼©é¢„è§ˆ" class="preview-image">
                    <div class="preview-info">
                        <div class="preview-stats">
                            <div class="stat-item">
                                <span class="stat-label">åŸå§‹å¤§å°</span>
                                <span class="stat-value original">${data.original_size}</span>
                            </div>
                            <div class="stat-arrow">â†’</div>
                            <div class="stat-item">
                                <span class="stat-label">å‹ç¼©å</span>
                                <span class="stat-value compressed">${data.compressed_size}</span>
                            </div>
                        </div>
                        <div class="compression-summary">
                            <span class="saved-space">èŠ‚çœ ${savedMB}MB</span>
                            <span class="compression-ratio" style="color: ${ratioColor}; font-weight: bold;">(${data.compression_ratio})</span>
                        </div>
                        ${savedRatio >= 90 ? '<div class="compression-badge">ğŸ”¥ æé™å‹ç¼©</div>' : 
                          savedRatio >= 70 ? '<div class="compression-badge">âš¡ é«˜æ•ˆå‹ç¼©</div>' : 
                          '<div class="compression-badge">âœ… æ ‡å‡†å‹ç¼©</div>'}
                        <div class="filename-info" style="margin-top: 8px; padding: 6px 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #6c757d;">
                            ğŸ“ æ–‡ä»¶å: ${data.filename || 'æœªçŸ¥'}
                        </div>
                    </div>
                </div>
            `;
            
            // å­˜å‚¨å‹ç¼©åçš„æ–‡ä»¶è·¯å¾„ä¾›è¡¨å•æäº¤ä½¿ç”¨
            window.compressedFilePath = data.compressed_path;
        }
        
        function removeCompressedPreview() {
            const previewDiv = document.getElementById('compressedPreview');
            if (previewDiv) {
                previewDiv.remove();
            }
            window.compressedFilePath = null;
            compressedImages = []; // æ¸…ç©ºå‹ç¼©å›¾ç‰‡æ•°ç»„
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            const photoInput = document.getElementById('photoInput');
            photoInput.value = '';
        }
        
        function showMultiImagePreview() {
            // åˆ›å»ºæˆ–æ›´æ–°å¤šå›¾ç‰‡é¢„è§ˆåŒºåŸŸ
            let previewDiv = document.getElementById('multiImagePreview');
            if (!previewDiv) {
                previewDiv = document.createElement('div');
                previewDiv.id = 'multiImagePreview';
                previewDiv.className = 'multi-image-preview';
                
                // æ’å…¥åˆ°ä¸Šä¼ æŒ‰é’®åé¢
                const uploadBtn = document.querySelector('.camera-btn');
                uploadBtn.parentNode.insertBefore(previewDiv, uploadBtn.nextSibling);
            }
            
            // è®¡ç®—æ±‡æ€»ç»Ÿè®¡
            let totalOriginalSize = 0;
            let totalCompressedSize = 0;
            
            compressedImages.forEach(img => {
                const originalMB = parseFloat(img.original_size);
                const compressedKB = parseFloat(img.compressed_size);
                totalOriginalSize += originalMB;
                totalCompressedSize += compressedKB / 1024;
            });
            
            const totalSaved = totalOriginalSize - totalCompressedSize;
            const totalCompressionRatio = (1 - totalCompressedSize / totalOriginalSize) * 100;
            
            // ç”Ÿæˆé¢„è§ˆHTML
            let imagesHtml = compressedImages.map((img, index) => `
                <div class="image-item">
                    <img src="/${img.path}" alt="å›¾ç‰‡${index + 1}" class="preview-image">
                    <div class="image-info">
                        <div class="filename">ğŸ“ ${img.filename}</div>
                        <div class="size-info">${img.original_size} â†’ ${img.compressed_size}</div>
                    </div>
                </div>
            `).join('');
            
            previewDiv.innerHTML = `
                <div class="preview-header">
                    <h4>ğŸ–¼ï¸ å¤šå›¾é¢„è§ˆ (${compressedImages.length} å¼ )</h4>
                    <button class="remove-preview" onclick="removeMultiImagePreview()">âœ•</button>
                </div>
                <div class="preview-stats">
                    <div class="stat-summary">
                        <span class="total-original">åŸå§‹æ€»è®¡: ${totalOriginalSize.toFixed(2)}MB</span>
                        <span class="arrow">â†’</span>
                        <span class="total-compressed">å‹ç¼©æ€»è®¡: ${totalCompressedSize.toFixed(1)}MB</span>
                        <span class="total-saved">èŠ‚çœ: ${totalSaved.toFixed(2)}MB</span>
                        <span class="total-ratio">(${totalCompressionRatio.toFixed(1)}%)</span>
                    </div>
                </div>
                <div class="images-grid">
                    ${imagesHtml}
                </div>
            `;
        }
        
        function removeMultiImagePreview() {
            const previewDiv = document.getElementById('multiImagePreview');
            if (previewDiv) {
                previewDiv.remove();
            }
            compressedImages = []; // æ¸…ç©ºå‹ç¼©å›¾ç‰‡æ•°ç»„
            window.compressedFilePath = null; // ä¹Ÿæ¸…ç©ºå•å¼ å›¾ç‰‡è·¯å¾„
        }
        
        function updateLicensePlateValidation() {
            const provinceSelect = document.getElementById('province_prefix');
            const letterSelect = document.getElementById('letter_prefix');
            const licenseInput = document.getElementById('license_plate');
            const helpDiv = document.getElementById('plateHelp');
            const isSpecial = provinceSelect.value === 'ç‰¹æ®Š';
            
            if (isSpecial) {
                // ç‰¹æ®Šè½¦ç‰Œæ¨¡å¼ï¼šéšè—ç¬¬äºŒæ ¼ï¼Œç¬¬ä¸€æ ¼æ˜¾ç¤º"ç‰¹æ®Š"ï¼Œç¬¬ä¸‰æ ¼å…è®¸ä¸­æ–‡è¾“å…¥
                letterSelect.style.display = 'none';
                // åªè½¬æ¢å¤§å†™ï¼Œä¸å¼ºåˆ¶æ›¿æ¢å†…å®¹
                if (licenseInput.value !== licenseInput.value.toUpperCase()) {
                    licenseInput.value = licenseInput.value.toUpperCase();
                }
                licenseInput.placeholder = 'å¦‚ï¼šä½¿123456';
                licenseInput.maxLength = 10;
                helpDiv.textContent = 'è¯·è¾“å…¥ç‰¹æ®Šè½¦ç‰Œå·ç ï¼ˆå¦‚ï¼šä½¿123456ï¼‰';
                helpDiv.style.color = '#666';
            } else {
                // æ™®é€šè½¦ç‰Œæ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰ä¸‰æ ¼
                letterSelect.style.display = 'block';
                
                // ç¬¬ä¸‰æ ¼åªå…è®¸æ•°å­—å’Œå­—æ¯ï¼Œ5-6ä½
                const currentValue = licenseInput.value;
                const cleanValue = currentValue.toUpperCase().replace(/[^A-Z0-9]/g, '');
                let finalValue = cleanValue;
                if (cleanValue.length > 6) {
                    finalValue = cleanValue.substring(0, 6);
                }
                
                // åªæœ‰å½“å€¼å®é™…æ”¹å˜æ—¶æ‰æ›´æ–°ï¼Œé¿å…é‡å¤è¾“å…¥
                if (currentValue !== finalValue) {
                    licenseInput.value = finalValue;
                }
                licenseInput.maxLength = 6;
                
                // æ ¹æ®å½“å‰è¾“å…¥ç»™å‡ºæç¤º
                if (finalValue.length === 0) {
                    helpDiv.textContent = 'è¯·è¾“å…¥5-6ä½æ•°å­—æˆ–å­—æ¯å¤§å†™ï¼ˆå¦‚ï¼š12345æˆ–A1B2C3ï¼‰';
                    helpDiv.style.color = '#666';
                } else if (finalValue.length < 5) {
                    helpDiv.textContent = `å·²è¾“å…¥${finalValue.length}ä½ï¼Œè¿˜éœ€${5-finalValue.length}ä½ï¼ˆæœ€å°‘5ä½ï¼‰`;
                    helpDiv.style.color = '#ff6b6b';
                } else if (finalValue.length >= 5 && finalValue.length <= 6) {
                    helpDiv.textContent = 'âœ“ è½¦ç‰Œå·ç æ ¼å¼æ­£ç¡®';
                    helpDiv.style.color = '#28a745';
                }
            }
        }
        
        function validateKeyPress(event) {
            const provinceSelect = document.getElementById('province_prefix');
            const licenseInput = document.getElementById('license_plate');
            const isSpecial = provinceSelect.value === 'ç‰¹æ®Š';
            
            if (isSpecial) {
                // ç‰¹æ®Šè½¦ç‰Œå…è®¸æ‰€æœ‰å­—ç¬¦
                return true;
            } else {
                // æ™®é€šè½¦ç‰Œåªå…è®¸æ•°å­—å’Œå­—æ¯ï¼Œä¸”ä¸è¶…è¿‡6ä½
                const currentValue = licenseInput.value;
                if (currentValue.length >= 6) {
                    return false; // é˜²æ­¢è¶…è¿‡6ä½
                }
                return event.charCode >= 48 && event.charCode <= 57 || 
                       event.charCode >= 65 && event.charCode <= 90 || 
                       event.charCode >= 97 && event.charCode <= 122;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–è½¦ç‰Œå·ç è¾“å…¥éªŒè¯
            updateLicensePlateValidation();
            
            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            bindDragEvents();
        });
        
        // ç»‘å®šæ‹–æ‹½äº‹ä»¶
        function bindDragEvents() {
            const dropZone = document.getElementById('dropZone');
            if (!dropZone) return;
        }
    </script>
</body>
</html>